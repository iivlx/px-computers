#include <windows.h>

#include <gl/GL.h>

#include "MainWindow.h"
#include "MainScreen.h"

#include "pxCPU.h"
#include "pxClock.h"
#include "pxDisplay.h"
#include "pxMainboard.h"
#include "pxRAM.h"
#include "pxROM.h"

#ifdef SUBSYSTEM_WINDOWS
int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) {
#endif

#ifdef SUBSYSTEM_CONSOLE
int main(int argc, char* argv[]) {
#endif

  // Initialize display
  MainWindow mainWindow(512, 512, "PxComputers");
  MainScreen screen(&mainWindow, 64, 64);

  // Create virtual computer

  // create devices
  PxMainboard* mainboard = new PxMainboard();
  PxCPU* cpu = new PxCPU(mainboard);
  PxClock* clock = new PxClock(100); // 100 Hz clock
  PxRAM* ram = new PxRAM(0x8000); // 32KB  RAM
  PxRAM* ram2 = new PxRAM(0x1E00); // 7,680 bytes secondary RAM
  PxROM* rom = new PxROM(0x200); // 256 bytes ROM
  PxDisplay* display = new PxDisplay(64, 64, true, 1.0f); // 64x64 display - 24,832 bytes

  // add devices to mainboard
  mainboard->addCPU(cpu);
  mainboard->addDevice("Display", display, 0x8000, 0x6100); // 8000 -> E0FF
  mainboard->addDevice("Clock", clock, 0xE100, 0x100); // E100 -> E1FF
  mainboard->addDevice("RAM1", ram, 0x0000, 0x8000); // 0000 -> 7FFF
  mainboard->addDevice("RAM2", ram2, 0xE200, 0x1C00); // E200 -> FDFF
  mainboard->addDevice("ROM", rom, 0xFE00, 0x200); // FE00 -> FFFF

  // configure mainboard
  mainboard->main_display = display;
  mainboard->setClock(clock); // synchronize clock with CPU
  mainboard->setResetVector(mainboard->devices[rom].first); // start in ROM

  // hardcode program in ROM
  uint8_t code[] = {
    /* data:     */ 
    0x80, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    /*_start: */
    /* 0xfe20: */ 0x00, 0x00, 0x00,                                 /* NOP  */
    /* 0xfe23: */ 0x00, 0x00, 0x00,                                 /* NOP  */
    /* 0xfe26: */ 0x01, 0x00, 0x20, 0x00, 0x10, 0x00, 0x00,         /* MOV [t], 0 */
    /*Loop: */
    /* 0xfe2d: */ 0x01, 0x00, 0x20, 0x00, 0x14, 0x00, 0x00,         /* MOV [Y], 0 */
    /*LoopY: */
    /* 0xfe34: */ 0x01, 0x00, 0x20, 0x00, 0x12, 0x00, 0x00,         /* MOV [X], 0 */
    /*LoopX: */
    /* 0xfe3b: */ 0x01, 0x00, 0x22, 0x00, 0x16, 0x00, 0x14,         /* MOV [P], [Y] */
    /* 0xfe42: */ 0x22, 0x00, 0x20, 0x00, 0x16, 0x00, 0x40,         /* MUL [P], 64 */
    /* 0xfe49: */ 0x20, 0x00, 0x22, 0x00, 0x16, 0x00, 0x12,         /* ADD [P], [X] */
    /* 0xfe50: */ 0x22, 0x00, 0x20, 0x00, 0x16, 0x00, 0x03,         /* MUL [P], 3 */
    /* 0xfe57: */ 0x20, 0x00, 0x20, 0x00, 0x16, 0x80, 0x00,         /* ADD [P], Display */
    /* 0xfe5e: */ 0x01, 0x00, 0x22, 0x00, 0x30, 0x00, 0x10,         /* MOV [S], [t] */
    /* 0xfe65: */ 0x50, 0x00, 0x20, 0x00, 0x30,                     /* HALF [S] */
    /* 0xfe6a: */ 0x54, 0x00, 0x20, 0x00, 0x30, 0x3E, 0x00,         /* HMUL [S], 1.5 */
    /* 0xfe71: */ 0x51, 0x00, 0x20, 0x00, 0x30,                     /* UHALF [S] */

    /* 0xfe76: */ 0x01, 0x00, 0x42, 0x00, 0x16, 0x00, 0x30,         /* MOV (P), [S] */

    /* 0xfe7d: */ 0x01, 0x00, 0x22, 0x00, 0x20, 0x00, 0x12,         /* MOV [Dx], [X] */
    /* 0xfe84: */ 0x21, 0x00, 0x20, 0x00, 0x20, 0x00, 0x20,         /* SUB [Dx], CENTER_X */
    /* 0xfe8b: */ 0x01, 0x00, 0x22, 0x00, 0x22, 0x00, 0x14,         /* MOV [Dy], [Y] */
    /* 0xfe92: */ 0x21, 0x00, 0x20, 0x00, 0x22, 0x00, 0x20,         /* SUB [Dy], CENTER_Y */
    /* 0xfe99: */ 0x30, 0x00, 0x22, 0x00, 0x20, 0x00, 0x20,         /* MULS [Dx], [Dx] */
    /* 0xfea0: */ 0x30, 0x00, 0x22, 0x00, 0x22, 0x00, 0x22,         /* MULS [Dy], [Dy] */
    /* 0xfea7: */ 0x01, 0x00, 0x22, 0x00, 0x24, 0x00, 0x20,         /* MOV [Dist], [Dx] */
    /* 0xfeae: */ 0x20, 0x00, 0x22, 0x00, 0x24, 0x00, 0x22,         /* ADD [Dist], [Dy] */
    /* 0xfeb5: */ 0x50, 0x00, 0x20, 0x00, 0x24,                     /* HALF [Dist] */
    /* 0xfeba: */ 0x59, 0x00, 0x20, 0x00, 0x24,                     /* SQRT [Dist] */
    /* 0xfebf: */ 0x50, 0x00, 0x20, 0x00, 0x22,                     /* HALF [Dy] */
    /* 0xfec4: */ 0x50, 0x00, 0x20, 0x00, 0x20,                     /* HALF [Dx] */
    /* 0xfec9: */ 0x01, 0x00, 0x22, 0x00, 0x26, 0x00, 0x22,         /* MOV [Angle], [Dy] */
    /* 0xfed0: */ 0x5A, 0x00, 0x22, 0x00, 0x26, 0x00, 0x20,         /* ATAN2 [Angle], [Dx] */

    /* 0xfed7: */ 0x01, 0x00, 0x22, 0x00, 0x30, 0x00, 0x10,         /* MOV [S], [t] */
    /* 0xfede: */ 0x50, 0x00, 0x20, 0x00, 0x30,                     /* HALF [S] */
    /* 0xfee3: */ 0x54, 0x00, 0x20, 0x00, 0x30, 0x32, 0x66,         /* HMUL [S], 0.2 */
    /* 0xfeea: */ 0x52, 0x00, 0x22, 0x00, 0x30, 0x00, 0x24,         /* HADD [S], [Dist] */
    /* 0xfef1: */ 0x53, 0x00, 0x22, 0x00, 0x30, 0x00, 0x26,         /* HSUB [S], [Angle] */
    /* 0xfef8: */ 0x5B, 0x00, 0x20, 0x00, 0x30,                     /* SIN [S] */

    /* 0xfefd: */ 0x54, 0x00, 0x20, 0x00, 0x30, 0x00, 0x7F,         /* HMUL [S], 127 */
    /* 0xff04: */ 0x52, 0x00, 0x20, 0x00, 0x30, 0x00, 0x80,         /* HADD [S], 128 */
    /* 0xff0b: */ 0x51, 0x00, 0x20, 0x00, 0x30,                     /* UHALF [S] */

    /* 0xff10: */ 0x41, 0x00, 0x20, 0x00, 0x12,                     /* INC [X] */
    /* 0xff15: */ 0x60, 0x02, 0x20, 0x00, 0x12, 0x00, 0x40,         /* CMP< [X], 64 */
    /* 0xff1c: */ 0x72, 0x01, 0x00, 0xFE, 0x3B,                     /* JLT> LoopX */
    /* 0xff21: */ 0x41, 0x00, 0x20, 0x00, 0x14,                     /* INC [Y] */
    /* 0xff26: */ 0x60, 0x02, 0x20, 0x00, 0x14, 0x00, 0x40,         /* CMP< [Y], 64 */
    /* 0xff2d: */ 0x72, 0x01, 0x00, 0xFE, 0x34,                     /* JLT> LoopY */
    /* 0xff32: */ 0x41, 0x00, 0x20, 0x00, 0x10,                     /* INC [t] */
    /* 0xff37: */ 0x60, 0x02, 0x20, 0x00, 0x10, 0x00, 0xFF,         /* CMP< [t], 255 */
    /* 0xff3e: */ 0x72, 0x01, 0x00, 0xFE, 0x2D,                     /* JLT> Loop */
    /* 0xff43: */ 0x70, 0x00, 0x00, 0xFE, 0x20,                     /* JMP _start */
  };
  rom->writeBytes(0x0000, code, sizeof(code));

  // add virtual computer's display to the screen and run
  screen.addDisplay(display);
  mainWindow.run(screen, std::vector<PxMainboard*>{mainboard});

  return 0;
}
